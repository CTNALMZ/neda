version: '3.8'

# =============================================================================
# NEDA Docker Compose Configuration
# =============================================================================
# Industrial-grade container orchestration for NEDA (Neural Engine for Digital Automation)
# Multi-service architecture with production-ready configuration
# =============================================================================

x-neda-defaults: &neda-defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "100m"
      max-file: "10"
      compress: "true"
      tag: "{{.Name}}"
  networks:
    - neda-frontend
    - neda-backend
  security_opt:
    - no-new-privileges:true
    - seccomp:unconfined
  cap_drop:
    - ALL
  cap_add:
    - NET_BIND_SERVICE
    - SYS_PTRACE
  read_only: true
  tmpfs:
    - /tmp:rw,noexec,nosuid,size=1g
    - /run:rw,noexec,nosuid
  ulimits:
    nofile:
      soft: 65536
      hard: 65536
    nproc:
      soft: 4096
      hard: 4096

x-neda-environment: &neda-environment
  TZ: UTC
  NODE_ENV: production
  LOG_LEVEL: INFO
  PYTHONUNBUFFERED: "1"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  ASPNETCORE_ENVIRONMENT: Production
  ASPNETCORE_URLS: http://+:8080;https://+:8443

# =============================================================================
# SERVICES
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Core AI Engine
  # ---------------------------------------------------------------------------
  neda-core:
    <<: *neda-defaults
    image: registry.neda.io/neda/core:${NEDA_VERSION:-2.1.0}
    container_name: neda-core
    hostname: neda-core
    build:
      context: ./NEDA.Core
      dockerfile: Dockerfile.core
      args:
        BUILD_VERSION: ${NEDA_VERSION:-2.1.0}
        BUILD_DATE: ${BUILD_DATE:-2024-01-15}
    environment:
      <<: *neda-environment
      NEDA_SERVICE_TYPE: core
      NEDA_REDIS_HOST: redis
      NEDA_DATABASE_HOST: postgres
      NEDA_RABBITMQ_HOST: rabbitmq
      NEDA_ELASTICSEARCH_HOST: elasticsearch
      NEDA_CONFIG_PATH: /etc/neda/config
      NEDA_DATA_PATH: /var/lib/neda
      NEDA_LOG_PATH: /var/log/neda
    ports:
      - "${NEDA_HTTP_PORT:-8080}:8080"
      - "${NEDA_HTTPS_PORT:-8443}:8443"
      - "${NEDA_GRPC_PORT:-50051}:50051"
      - "${NEDA_METRICS_PORT:-9090}:9090"
    volumes:
      - neda-config:/etc/neda:ro
      - neda-data:/var/lib/neda:rw
      - neda-logs:/var/log/neda:rw
      - ./NEDA.Core/Configuration:/etc/neda/config:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '${NEDA_CORE_CPU_LIMIT:-4.0}'
          memory: ${NEDA_CORE_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${NEDA_CORE_CPU_RESERVE:-1.0}'
          memory: ${NEDA_CORE_MEMORY_RESERVE:-2G}
    secrets:
      - neda-db-password
      - neda-redis-password
      - neda-jwt-secret
      - neda-encryption-key
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - elasticsearch

  # ---------------------------------------------------------------------------
  # AI Processing Engine
  # ---------------------------------------------------------------------------
  neda-ai:
    <<: *neda-defaults
    image: registry.neda.io/neda/ai:${NEDA_VERSION:-2.1.0}
    container_name: neda-ai
    hostname: neda-ai
    build:
      context: ./NEDA.AI
      dockerfile: Dockerfile.ai
      args:
        CUDA_VERSION: ${CUDA_VERSION:-11.8}
        PYTHON_VERSION: ${PYTHON_VERSION:-3.10}
    environment:
      <<: *neda-environment
      NEDA_SERVICE_TYPE: ai
      NEDA_CORE_HOST: neda-core
      NEDA_GPU_ENABLED: ${NEDA_GPU_ENABLED:-false}
      CUDA_VISIBLE_DEVICES: ${CUDA_VISIBLE_DEVICES:-0}
      NVIDIA_VISIBLE_DEVICES: ${NVIDIA_VISIBLE_DEVICES:-all}
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
      TF_FORCE_GPU_ALLOW_GROWTH: "true"
      OMP_NUM_THREADS: ${OMP_NUM_THREADS:-4}
    ports:
      - "${NEDA_AI_PORT:-5000}:5000"
    volumes:
      - neda-models:/models:rw
      - neda-data:/data:rw
      - ./NEDA.AI/Models:/app/models:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "python3", "-c", "import requests; exit(0 if requests.get('http://localhost:5000/health').status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${NEDA_AI_CPU_LIMIT:-8.0}'
          memory: ${NEDA_AI_MEMORY_LIMIT:-16G}
          devices:
            - driver: nvidia
              count: ${NVIDIA_GPU_COUNT:-1}
              capabilities: [gpu]
        reservations:
          cpus: '${NEDA_AI_CPU_RESERVE:-2.0}'
          memory: ${NEDA_AI_MEMORY_RESERVE:-4G}
    secrets:
      - neda-ai-api-key
    depends_on:
      neda-core:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # Web UI Service
  # ---------------------------------------------------------------------------
  neda-ui:
    <<: *neda-defaults
    image: registry.neda.io/neda/ui:${NEDA_VERSION:-2.1.0}
    container_name: neda-ui
    hostname: neda-ui
    build:
      context: ./NEDA.UI
      dockerfile: Dockerfile.ui
      args:
        NODE_VERSION: ${NODE_VERSION:-18}
    environment:
      <<: *neda-environment
      NEDA_SERVICE_TYPE: ui
      NEDA_API_URL: http://neda-core:8080
      NEDA_AI_URL: http://neda-ai:5000
      REACT_APP_VERSION: ${NEDA_VERSION:-2.1.0}
      REACT_APP_ENVIRONMENT: production
    ports:
      - "${NEDA_UI_PORT:-3000}:3000"
    volumes:
      - ./NEDA.UI/Assets:/app/public/assets:ro
      - ./NEDA.UI/Themes:/app/src/themes:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${NEDA_UI_CPU_LIMIT:-2.0}'
          memory: ${NEDA_UI_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${NEDA_UI_CPU_RESERVE:-0.5}'
          memory: ${NEDA_UI_MEMORY_RESERVE:-1G}
    depends_on:
      neda-core:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # API Gateway
  # ---------------------------------------------------------------------------
  neda-gateway:
    <<: *neda-defaults
    image: nginx:${NGINX_VERSION:-1.25}-alpine
    container_name: neda-gateway
    hostname: neda-gateway
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - neda-ssl:/etc/nginx/ssl:ro
      - neda-logs:/var/log/nginx:rw
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${NGINX_CPU_LIMIT:-2.0}'
          memory: ${NGINX_MEMORY_LIMIT:-2G}
        reservations:
          cpus: '${NGINX_CPU_RESERVE:-0.5}'
          memory: ${NGINX_MEMORY_RESERVE:-512M}
    depends_on:
      - neda-core
      - neda-ui

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    <<: *neda-defaults
    image: postgres:${POSTGRES_VERSION:-15}-alpine
    container_name: neda-postgres
    hostname: neda-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-neda}
      POSTGRES_USER: ${POSTGRES_USER:-neda_admin}
      POSTGRES_PASSWORD_FILE: /run/secrets/neda-db-password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data:rw
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
      - /etc/localtime:/etc/localtime:ro
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=1GB
      - -c
      - effective_cache_size=3GB
      - -c
      - maintenance_work_mem=256MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=16MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=5242kB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB
      - -c
      - max_worker_processes=8
      - -c
      - max_parallel_workers_per_gather=4
      - -c
      - max_parallel_workers=8
      - -c
      - max_parallel_maintenance_workers=4
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '${POSTGRES_CPU_LIMIT:-4.0}'
          memory: ${POSTGRES_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${POSTGRES_CPU_RESERVE:-1.0}'
          memory: ${POSTGRES_MEMORY_RESERVE:-2G}
    secrets:
      - neda-db-password

  # ---------------------------------------------------------------------------
  # Redis Cache
  # ---------------------------------------------------------------------------
  redis:
    <<: *neda-defaults
    image: redis:${REDIS_VERSION:-7}-alpine
    container_name: neda-redis
    hostname: neda-redis
    command:
      - redis-server
      - /usr/local/etc/redis/redis.conf
      - --requirepass
      - "$${REDIS_PASSWORD}"
    environment:
      REDIS_PASSWORD_FILE: /run/secrets/neda-redis-password
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_DATABASES: ${REDIS_DATABASES:-16}
      REDIS_MAXMEMORY: ${REDIS_MAXMEMORY:-2gb}
      REDIS_MAXMEMORY_POLICY: allkeys-lru
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data:rw
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${REDIS_CPU_LIMIT:-2.0}'
          memory: ${REDIS_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${REDIS_CPU_RESERVE:-0.5}'
          memory: ${REDIS_MEMORY_RESERVE:-1G}
    secrets:
      - neda-redis-password

  # ---------------------------------------------------------------------------
  # RabbitMQ Message Broker
  # ---------------------------------------------------------------------------
  rabbitmq:
    <<: *neda-defaults
    image: rabbitmq:${RABBITMQ_VERSION:-3.12}-management-alpine
    container_name: neda-rabbitmq
    hostname: neda-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-neda}
      RABBITMQ_DEFAULT_PASS_FILE: /run/secrets/neda-rabbitmq-password
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/neda}
      RABBITMQ_ERLANG_COOKIE: ${RABBITMQ_ERLANG_COOKIE:-NEDA_SECURE_COOKIE}
      RABBITMQ_NODENAME: rabbit@neda-rabbitmq
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit log_levels [{connection,error},{default,error}]"
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq:rw
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '${RABBITMQ_CPU_LIMIT:-2.0}'
          memory: ${RABBITMQ_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${RABBITMQ_CPU_RESERVE:-0.5}'
          memory: ${RABBITMQ_MEMORY_RESERVE:-1G}
    secrets:
      - neda-rabbitmq-password

  # ---------------------------------------------------------------------------
  # Elasticsearch for Logging and Search
  # ---------------------------------------------------------------------------
  elasticsearch:
    <<: *neda-defaults
    image: elasticsearch:${ELASTICSEARCH_VERSION:-8.11.0}
    container_name: neda-elasticsearch
    hostname: neda-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.transport.ssl.enabled=true
      - xpack.security.transport.ssl.verification_mode=certificate
      - xpack.security.transport.ssl.keystore.path=certs/elastic-certificates.p12
      - xpack.security.transport.ssl.truststore.path=certs/elastic-certificates.p12
      - xpack.security.http.ssl.enabled=true
      - xpack.security.http.ssl.keystore.path=certs/elastic-certificates.p12
      - xpack.security.http.ssl.truststore.path=certs/elastic-certificates.p12
      - xpack.security.authc.api_key.enabled=true
      - ES_JAVA_OPTS=-Xms2g -Xmx2g
      - ELASTIC_PASSWORD_FILE=/run/secrets/neda-elastic-password
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
      - "${ELASTICSEARCH_TRANSPORT_PORT:-9300}:9300"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data:rw
      - ./elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
      - ./elasticsearch/certs:/usr/share/elasticsearch/config/certs:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -s -u elastic:$${ELASTIC_PASSWORD} http://localhost:9200/_cluster/health | grep -q '\"status\":\"green\"' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '${ELASTICSEARCH_CPU_LIMIT:-4.0}'
          memory: ${ELASTICSEARCH_MEMORY_LIMIT:-8G}
        reservations:
          cpus: '${ELASTICSEARCH_CPU_RESERVE:-1.0}'
          memory: ${ELASTICSEARCH_MEMORY_RESERVE:-2G}
    secrets:
      - neda-elastic-password

  # ---------------------------------------------------------------------------
  # Kibana for Visualization
  # ---------------------------------------------------------------------------
  kibana:
    <<: *neda-defaults
    image: kibana:${KIBANA_VERSION:-8.11.0}
    container_name: neda-kibana
    hostname: neda-kibana
    environment:
      - ELASTICSEARCH_HOSTS=https://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=kibana_system
      - ELASTICSEARCH_PASSWORD_FILE=/run/secrets/neda-kibana-password
      - ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=/usr/share/kibana/config/certs/ca.crt
      - SERVER_SSL_ENABLED=true
      - SERVER_SSL_CERTIFICATE=/usr/share/kibana/config/certs/elastic-certificates.p12
      - SERVER_SSL_KEY=/usr/share/kibana/config/certs/elastic-certificates.p12
    ports:
      - "${KIBANA_PORT:-5601}:5601"
    volumes:
      - ./kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
      - ./elasticsearch/certs:/usr/share/kibana/config/certs:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5601/api/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          cpus: '${KIBANA_CPU_LIMIT:-2.0}'
          memory: ${KIBANA_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${KIBANA_CPU_RESERVE:-0.5}'
          memory: ${KIBANA_MEMORY_RESERVE:-1G}
    depends_on:
      elasticsearch:
        condition: service_healthy
    secrets:
      - neda-kibana-password

  # ---------------------------------------------------------------------------
  # Prometheus for Monitoring
  # ---------------------------------------------------------------------------
  prometheus:
    <<: *neda-defaults
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    container_name: neda-prometheus
    hostname: neda-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - prometheus-data:/prometheus:rw
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - ./prometheus/alerts:/etc/prometheus/alerts:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${PROMETHEUS_CPU_LIMIT:-2.0}'
          memory: ${PROMETHEUS_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${PROMETHEUS_CPU_RESERVE:-0.5}'
          memory: ${PROMETHEUS_MEMORY_RESERVE:-1G}

  # ---------------------------------------------------------------------------
  # Grafana for Dashboards
  # ---------------------------------------------------------------------------
  grafana:
    <<: *neda-defaults
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: neda-grafana
    hostname: neda-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD_FILE=/run/secrets/neda-grafana-password
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel
      - GF_FEATURE_TOGGLES_ENABLE=publicDashboards
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    volumes:
      - grafana-data:/var/lib/grafana:rw
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${GRAFANA_CPU_LIMIT:-2.0}'
          memory: ${GRAFANA_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${GRAFANA_CPU_RESERVE:-0.5}'
          memory: ${GRAFANA_MEMORY_RESERVE:-1G}
    depends_on:
      prometheus:
        condition: service_started
    secrets:
      - neda-grafana-password

  # ---------------------------------------------------------------------------
  # MinIO for Object Storage
  # ---------------------------------------------------------------------------
  minio:
    <<: *neda-defaults
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: neda-minio
    hostname: neda-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/neda-minio-root-user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/neda-minio-root-password
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      MINIO_BROWSER: "on"
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data:rw
      - ./minio/config:/root/.minio:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${MINIO_CPU_LIMIT:-2.0}'
          memory: ${MINIO_MEMORY_LIMIT:-4G}
        reservations:
          cpus: '${MINIO_CPU_RESERVE:-0.5}'
          memory: ${MINIO_MEMORY_RESERVE:-1G}
    secrets:
      - neda-minio-root-user
      - neda-minio-root-password

  # ---------------------------------------------------------------------------
  # Traefik for Edge Routing (Alternative to Nginx)
  # ---------------------------------------------------------------------------
  traefik:
    <<: *neda-defaults
    image: traefik:${TRAEFIK_VERSION:-latest}
    container_name: neda-traefik
    hostname: neda-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=${TRAEFIK_ACME_EMAIL:-admin@neda.io}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
    ports:
      - "80:80"
      - "443:443"
      - "${TRAEFIK_DASHBOARD_PORT:-8081}:8080"
    volumes:
      - traefik-data:/letsencrypt:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '${TRAEFIK_CPU_LIMIT:-1.0}'
          memory: ${TRAEFIK_MEMORY_LIMIT:-1G}
        reservations:
          cpus: '${TRAEFIK_CPU_RESERVE:-0.25}'
          memory: ${TRAEFIK_MEMORY_RESERVE:-256M}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.neda.local`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=myresolver"

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  neda-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/config
  neda-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
  neda-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/logs
  neda-models:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/models
  neda-ssl:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/ssl
  postgres-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/postgres
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/redis
  rabbitmq-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/rabbitmq
  elasticsearch-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/elasticsearch
  prometheus-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/prometheus
  grafana-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/grafana
  minio-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/minio
  traefik-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data/traefik

# =============================================================================
# SECRETS
# =============================================================================

secrets:
  neda-db-password:
    file: ./secrets/postgres_password.txt
  neda-redis-password:
    file: ./secrets/redis_password.txt
  neda-rabbitmq-password:
    file: ./secrets/rabbitmq_password.txt
  neda-elastic-password:
    file: ./secrets/elastic_password.txt
  neda-kibana-password:
    file: ./secrets/kibana_password.txt
  neda-grafana-password:
    file: ./secrets/grafana_password.txt
  neda-minio-root-user:
    file: ./secrets/minio_root_user.txt
  neda-minio-root-password:
    file: ./secrets/minio_root_password.txt
  neda-jwt-secret:
    file: ./secrets/jwt_secret.txt
  neda-encryption-key:
    file: ./secrets/encryption_key.txt
  neda-ai-api-key:
    file: ./secrets/ai_api_key.txt

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  neda-frontend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: neda-frontend
    ipam:
      driver: default
      config:
        - subnet: 10.10.1.0/24
          gateway: 10.10.1.1
  neda-backend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: neda-backend
    internal: true
    ipam:
      driver: default
      config:
        - subnet: 10.10.2.0/24
          gateway: 10.10.2.1

# =============================================================================
# ENVIRONMENT VARIABLES (.env file)
# =============================================================================

# Create a .env file in the same directory with the following variables:
#
# # Version tags
# NEDA_VERSION=2.1.0
# NGINX_VERSION=1.25
# POSTGRES_VERSION=15
# REDIS_VERSION=7
# RABBITMQ_VERSION=3.12
# ELASTICSEARCH_VERSION=8.11.0
# KIBANA_VERSION=8.11.0
# PROMETHEUS_VERSION=latest
# GRAFANA_VERSION=latest
# MINIO_VERSION=latest
# TRAEFIK_VERSION=latest
# NODE_VERSION=18
# PYTHON_VERSION=3.10
# CUDA_VERSION=11.8
#
# # Port configurations
# NEDA_HTTP_PORT=8080
# NEDA_HTTPS_PORT=8443
# NEDA_GRPC_PORT=50051
# NEDA_METRICS_PORT=9090
# NEDA_AI_PORT=5000
# NEDA_UI_PORT=3000
# POSTGRES_PORT=5432
# REDIS_PORT=6379
# RABBITMQ_PORT=5672
# RABBITMQ_MANAGEMENT_PORT=15672
# ELASTICSEARCH_PORT=9200
# ELASTICSEARCH_TRANSPORT_PORT=9300
# KIBANA_PORT=5601
# PROMETHEUS_PORT=9091
# GRAFANA_PORT=3001
# MINIO_API_PORT=9000
# MINIO_CONSOLE_PORT=9001
# TRAEFIK_DASHBOARD_PORT=8081
#
# # Resource limits
# NEDA_CORE_CPU_LIMIT=4.0
# NEDA_CORE_MEMORY_LIMIT=8G
# NEDA_CORE_CPU_RESERVE=1.0
# NEDA_CORE_MEMORY_RESERVE=2G
# NEDA_AI_CPU_LIMIT=8.0
# NEDA_AI_MEMORY_LIMIT=16G
# NEDA_AI_CPU_RESERVE=2.0
# NEDA_AI_MEMORY_RESERVE=4G
# NEDA_UI_CPU_LIMIT=2.0
# NEDA_UI_MEMORY_LIMIT=4G
# NEDA_UI_CPU_RESERVE=0.5
# NEDA_UI_MEMORY_RESERVE=1G
# NGINX_CPU_LIMIT=2.0
# NGINX_MEMORY_LIMIT=2G
# NGINX_CPU_RESERVE=0.5
# NGINX_MEMORY_RESERVE=512M
# POSTGRES_CPU_LIMIT=4.0
# POSTGRES_MEMORY_LIMIT=8G
# POSTGRES_CPU_RESERVE=1.0
# POSTGRES_MEMORY_RESERVE=2G
# REDIS_CPU_LIMIT=2.0
# REDIS_MEMORY_LIMIT=4G
# REDIS_CPU_RESERVE=0.5
# REDIS_MEMORY_RESERVE=1G
# RABBITMQ_CPU_LIMIT=2.0
# RABBITMQ_MEMORY_LIMIT=4G
# RABBITMQ_CPU_RESERVE=0.5
# RABBITMQ_MEMORY_RESERVE=1G
# ELASTICSEARCH_CPU_LIMIT=4.0
# ELASTICSEARCH_MEMORY_LIMIT=8G
# ELASTICSEARCH_CPU_RESERVE=1.0
# ELASTICSEARCH_MEMORY_RESERVE=2G
# KIBANA_CPU_LIMIT=2.0
# KIBANA_MEMORY_LIMIT=4G
# KIBANA_CPU_RESERVE=0.5
# KIBANA_MEMORY_RESERVE=1G
# PROMETHEUS_CPU_LIMIT=2.0
# PROMETHEUS_MEMORY_LIMIT=4G
# PROMETHEUS_CPU_RESERVE=0.5
# PROMETHEUS_MEMORY_RESERVE=1G
# GRAFANA_CPU_LIMIT=2.0
# GRAFANA_MEMORY_LIMIT=4G
# GRAFANA_CPU_RESERVE=0.5
# GRAFANA_MEMORY_RESERVE=1G
# MINIO_CPU_LIMIT=2.0
# MINIO_MEMORY_LIMIT=4G
# MINIO_CPU_RESERVE=0.5
# MINIO_MEMORY_RESERVE=1G
# TRAEFIK_CPU_LIMIT=1.0
# TRAEFIK_MEMORY_LIMIT=1G
# TRAEFIK_CPU_RESERVE=0.25
# TRAEFIK_MEMORY_RESERVE=256M
#
# # Database configurations
# POSTGRES_DB=neda
# POSTGRES_USER=neda_admin
# REDIS_DATABASES=16
# REDIS_MAXMEMORY=2gb
# RABBITMQ_USER=neda
# RABBITMQ_VHOST=/neda
# RABBITMQ_ERLANG_COOKIE=NEDA_SECURE_COOKIE
# MINIO_REGION=us-east-1
#
# # AI/GPU configurations
# NEDA_GPU_ENABLED=false
# CUDA_VISIBLE_DEVICES=0
# NVIDIA_VISIBLE_DEVICES=all
# NVIDIA_GPU_COUNT=1
# OMP_NUM_THREADS=4
#
# # Traefik configurations
# TRAEFIK_ACME_EMAIL=admin@neda.io