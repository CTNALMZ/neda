 using System;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Media.Animation;
using NEDA.Interface.TextInput.ChatWindow.ViewModels;

namespace NEDA.Interface.TextInput.ChatWindow
{
    ///<summary>
    /// Interaction logic for ConversationView.xaml
    ///</summary>
public partial class ConversationView : UserControl
    {
        private ScrollViewer _scrollViewer;
        private bool _isAutoScrolling = true;

        public ConversationView()
        {
            InitializeComponent();
            DataContextChanged += OnDataContextChanged;
        }

        private void OnDataContextChanged(object sender, DependencyPropertyChangedEventArgs e)
        {
            if (e.OldValue is ChatViewModel oldViewModel)
            {
                oldViewModel.ScrollRequested -= OnScrollRequested;
                oldViewModel.FocusRequested -= OnFocusRequested;
            }

            if (e.NewValue is ChatViewModel newViewModel)
            {
                newViewModel.ScrollRequested += OnScrollRequested;
                newViewModel.FocusRequested += OnFocusRequested;
            }
        }

        private void UserControl_Loaded(object sender, RoutedEventArgs e)
        {
            // Find the ScrollViewer in the ListBox template
            if (VisualTreeHelper.GetChildrenCount(MessagesListBox) > 0)
            {
                var border = (Border)VisualTreeHelper.GetChild(MessagesListBox, 0);
                _scrollViewer = (ScrollViewer)VisualTreeHelper.GetChild(border, 0);
                
                if (_scrollViewer != null)
                {
                    _scrollViewer.ScrollChanged += OnScrollChanged;
                }
            }

            // Set focus to textbox
            Dispatcher.BeginInvoke(new Action(() =>
            {
                MessageTextBox.Focus();
            }), System.Windows.Threading.DispatcherPriority.Background);
        }

        private void UserControl_Unloaded(object sender, RoutedEventArgs e)
        {
            if (_scrollViewer != null)
            {
                _scrollViewer.ScrollChanged -= OnScrollChanged;
            }

            if (DataContext is ChatViewModel viewModel)
            {
                viewModel.ScrollRequested -= OnScrollRequested;
                viewModel.FocusRequested -= OnFocusRequested;
            }
        }

        private void MessageTextBox_PreviewKeyDown(object sender, KeyEventArgs e)
        {
            var textBox = sender as TextBox;
            if (textBox == null) return;

            // Handle Enter without Shift to send message
            if (e.Key == Key.Enter)
            {
                if (Keyboard.Modifiers == ModifierKeys.None)
                {
                    if (DataContext is ChatViewModel viewModel && viewModel.CanSendMessage)
                    {
                        viewModel.SendMessageCommand.Execute(textBox.Text);
                        e.Handled = true;
                    }
                }
            }
            // Handle Escape to clear input
            else if (e.Key == Key.Escape)
            {
                textBox.Clear();
                e.Handled = true;
            }
        }

        private void OnScrollChanged(object sender, ScrollChangedEventArgs e)
        {
            if (_scrollViewer == null) return;

            // Check if user is at the bottom
            double verticalOffset = _scrollViewer.VerticalOffset;
            double scrollableHeight = _scrollViewer.ScrollableHeight;
            
            _isAutoScrolling = Math.Abs(verticalOffset - scrollableHeight)
<10;

            if (DataContext is ChatViewModel viewModel)
            {
                viewModel.ShowScrollToBottom = !_isAutoScrolling;
            }
        }

        private void OnScrollRequested(object sender, ScrollToBottomEventArgs e)
        {
            Dispatcher.BeginInvoke(new Action(() =>
    {
                if (_scrollViewer != null)
                {
                    _scrollViewer.ScrollToEnd();
                    _isAutoScrolling = true;
                }
            }), System.Windows.Threading.DispatcherPriority.Background);
        }

        private void OnFocusRequested(object sender, EventArgs e)
        {
            Dispatcher.BeginInvoke(new Action(() =>
            {
                MessageTextBox.Focus();
            }), System.Windows.Threading.DispatcherPriority.Background);
        }

        private void MessagesListBox_Loaded(object sender, RoutedEventArgs e)
        {
            // Auto-scroll to bottom when new items are added
            var listBox = sender as ListBox;
            if (listBox != null && listBox.Items.Count > 0)
            {
                listBox.ScrollIntoView(listBox.Items[listBox.Items.Count - 1]);
            }
        }
    }

    ///
    <summary>
        /// Custom EventArgs for scroll requests
    ///</summary>
    public class ScrollToBottomEventArgs : EventArgs
    {
        public bool Animate { get; set; } = true;
    }

    ///
    <summary>
        /// Template selector for different message types
    ///</summary>
    public class MessageTemplateSelector : DataTemplateSelector
    {
        public DataTemplate UserMessageTemplate { get; set; }
        public DataTemplate SystemMessageTemplate { get; set; }
        public DataTemplate ErrorMessageTemplate { get; set; }
        public DataTemplate WarningMessageTemplate { get; set; }
        public DataTemplate SuccessMessageTemplate { get; set; }
        public DataTemplate TypingIndicatorTemplate { get; set; }

        public override DataTemplate SelectTemplate(object item, DependencyObject container)
        {
            if (item is ChatMessageViewModel message)
            {
                return message.MessageType switch
                {
                    MessageType.User => UserMessageTemplate,
                    MessageType.System => SystemMessageTemplate,
                    MessageType.Error => ErrorMessageTemplate,
                    MessageType.Warning => WarningMessageTemplate,
                    MessageType.Success => SuccessMessageTemplate,
                    MessageType.Typing => TypingIndicatorTemplate,
                    _ => SystemMessageTemplate
                };
            }

            return base.SelectTemplate(item, container);
        }
    }

    ///
    <summary>
        /// Message type enumeration
    ///</summary>
    public enum MessageType
    {
        User,
        System,
        Error,
        Warning,
        Success,
        Typing
    }

    ///
    <summary>
        /// ViewModel for chat messages
    ///</summary>
    public class ChatMessageViewModel
    {
        public string Message { get; set; }
        public MessageType MessageType { get; set; }
        public DateTime Timestamp { get; set; }
        public string Sender { get; set; }
        public bool IsSent { get; set; }
        public bool IsRead { get; set; }
    }
}